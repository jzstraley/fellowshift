# Changelog

## 2026-02-26 — Request Cancellation & Fellow Visibility Scoping

- Fellows can now cancel their own pending vacation, day-off, and swap requests via a Cancel button (sets status to `cancelled`)
- Request lists are now scoped: non-approvers only see requests they submitted or that involve their linked fellow record; admins/approvers see all
- Added `cancelled` as a valid status in `vacation_requests` and `swap_requests` schema CHECK constraints
- Username and full name fields in Profile Settings are now read-only for non-admin users; only admins can edit identity fields and see the Save button
- Renamed `lecture_speakers` table reference to `speakers` in Supabase sync (fixes "could not find table public.lecture_speaker" error)
- Renamed lecture columns: `lecture_date` → `date`, `lecture_time` → `time`, `presenter_fellow` → `presenter_fellow_id`
- Added `program` field to lecture rows on push/pull
- Removed `rsvps` column from lectures (no longer pushed or pulled)

## 2026-02-24 — Supabase Schedule Sync

- Validate & Save button pushes full schedule to Supabase; Sync button pulls on demand; approving vacation/swap requests now writes directly to schedule_assignments and mirrors into local state
- Call weekend/float and clinic coverage tables now render as stacked cards on mobile; calendar scrolls horizontally instead of squishing
- Timeout now navigates to the landing page instead of reloading to the demo/base screen
- Replaced duplicate hamburger icon on user menu with a CircleUser icon to visually distinguish it from the nav menu toggle
- Fixed time off request form: fellows query now fetches `user_id` so regular fellows correctly see themselves in the Fellow dropdown (previously always empty for non-admin users)

## 2026-02-22 — Navigation Gating & Stats Permissions

- Stats view is now gated to approvers/admins when Supabase is configured; hidden for regular fellows
- HeaderBar nav tabs are hidden entirely for unauthenticated users; shown in demo mode (no Supabase configured)
- Stats tab added via splice to preserve correct tab ordering
- Removed debounced call/float generator (debouncedGenerate); optimize button calls generator directly
- ScheduleView: block header now groups consecutive blocks by rotation number with a spanning header row
- ScheduleView: PGY divider rows separate fellows by PGY level
- ScheduleView: current block column is highlighted; view uses full block list from blockDates (not single-block selector)
- ViolationsView: redesigned table with severity dot indicators, styled badges per rule type, and date range display (single date or range)
- CalendarView: block selector auto-detects today's block on load; days filtered to selected block and grouped by month
- ScheduleEditorView: added change log panel showing recent edits; `undoTo(index)` allows jumping to any prior state in history

## 2026-02-21 — Admin View & Role-Based Access

- Added AdminView component (admin-only tab) for managing institution users: list all profiles, change roles, invite new users by email
- Admin tab appears in navigation only for users with `admin` role
- Import/Export bar on Dashboard now gated to admin/program_director/chief_fellow only
- Check Balance button and table gated to program_director/admin roles
- Added `supabase_migration_roles.sql` with role-based RLS policy migrations
- Fixed white overscroll area on mobile: `html` and `body` now have explicit background colors matching the app theme (`gray-50` in light mode, `gray-900` in dark mode)
- Call/Float Balance Check table in the Call/Float view is now only visible to program directors
- "Check Balance" button in the toolbar is now only rendered for program directors
- Fixed a race condition where the schedule recalculation effect (150ms debounce) would overwrite call/float counts with zeros after `generateCallAndFloat()` ran on mount — call/float values now persist across schedule re-renders
- Added a monthly calendar above the Weekly Clinic Coverage for Nights table in the Clinic Coverage view, similar in style to the Lecture Calendar
- Calendar shows all fellows in clinic each weekday: PGY-colored badges for regular clinic, amber badges (Name*) for fellows covering a nights fellow's clinic slot, and red badges (!Name) for uncovered slots
- Month navigation arrows (‹ ›) allow browsing through the academic year
- Removed the ▼ clinic day indicator that was previously shown in each schedule cell in the Schedule view
- Replaced horizontal-scroll block table in Schedule view with a block selector dropdown showing all 26 blocks with date ranges
- Table now displays only the selected block's column — no horizontal scrolling needed
- App auto-detects today's date on load and pre-selects the current block; falls back to Block 1 if before the schedule year
- Current block is marked with a ★ in the dropdown and a blue header with "Current" badge in the table
- Rotation filter and fellow/rotation click-to-highlight remain fully functional in the single-block view
- Added username and access level display in the top-right header bar beside the hamburger menu, showing the user's full name and formatted role (Program Director, Chief Fellow, Fellow, Viewer)
- Replaced "Start Block" and "End Block" number inputs in the time off request creator with "Start Date" and "End Date" dropdowns showing actual calendar dates from configured block dates

## 2026-02-18 — Dashboard Redesign

- Redesigned Dashboard with time-of-day greeting and gradient hero banner showing current block, days remaining, and year progress bar
- Upgraded cards with colored icon badges, hover highlights, and improved visual hierarchy
- Non-admin users now see "My Requests" (their own pending requests) instead of global counts
- Added "Quick Links" card for non-admins with shortcuts to Request Time Off, Swap Rotation, Full Calendar, and View Stats
- Admin users see "Pending Approvals" and ACGME Violations cards
- Improved empty states with helpful messages
- Call/Night Float duties shown with colored pill badges
- Pinned the Import/Export bar to the bottom of the screen on the Home (Dashboard) view so it stays visible while scrolling
- Fixed Clinic Coverage Load Distribution cards: text was invisible in light mode (white on white); added explicit dark text colors
- Reduced column spacing in Weekly Clinic Coverage for Nights table for a more compact layout
- Fixed block number and cell text visibility in Clinic Coverage table for both light and dark modes
- Added Dashboard home view as the default landing page after login; shows current rotation, upcoming call/float, pending requests, upcoming lectures, and active violations (admin only)
- Refactored undo system in Schedule Editor to support full undo/redo with dual stacks (max 30 snapshots); added Redo button and Ctrl+Z / Ctrl+Shift+Z keyboard bindings
- Added Validate button to Schedule Editor that runs conflict detection before saving: checks for double-booked day overrides, coverage gaps (ICU, Floor A/B, Nights), and ACGME violations
- Added global keyboard shortcuts: 1–9 to switch views, ←/→ arrow keys for month navigation in Lecture Calendar, Escape to close modals, Ctrl+K to focus search (Phase 2)
- Added session idle timeout: auto-signs out after 15 minutes of inactivity with a warning modal at 13 minutes
- Added "Home" tab to header navigation as the first entry
- Added ACGME work hour violation checker engine that builds a day-by-day shift timeline per fellow and flags 80h weekly average, 24+4h max shift, 1-in-7 day off, and other ACGME rule violations
- Added Violations view with filters by fellow, rule, and severity
- Added violation fix suggester that proposes swap/reassignment options to resolve violations without introducing new ones
- Added "Suggest Fix" button on each violation row with expandable suggestion details
- Added swap request workflow to Vacations view (sub-view toggle between time-off requests and swap requests)
- Swap requests are backed by Supabase with approval/denial tracking
- Replaced plain localStorage with AES-GCM encrypted storage; encryption key derived from user ID
- Removed GmailIntegration component

## 2026-02-14

- Added initial clinic coverage schedule (initialClinicSchedule) with pre-assigned coverers for all 26 blocks, balanced at 4 covers per fellow
- Full dark/light theme overhaul: added explicit dark: variants to every component (StatsView, CallView, CalendarView, ClinicCoverageView, ScheduleView, ImportExportBar)
- Removed aggressive CSS !important overrides from index.css; dark mode now handled via Tailwind dark: utilities
- Fixed ImportExportBar status messages being unreadable in dark mode
- Added Changelog link to the user dropdown menu in the header
- Made Schedule view read-only; removed drag-and-drop swapping, tap-to-swap, and Vacation Mode editing
- Added rotation filter dropdown to Schedule view for highlighting all instances of a selected rotation
- Cleaned up unused schedule/vacation editing props and helper functions from ScheduleView
- Increased Stats view table font size to match Call/Float table (text-xs)

## 2026-02-10

- Current block row on the Call/Float page is now automatically highlighted with a yellow background and left border
- Added dark mode support to Call/Float Balance Check table
- Integrated Requests page with Supabase
- Vacation requests now fetch from the database scoped to the user's institution
- Program directors and chief fellows can approve/deny requests with audit tracking
- Fellows can submit vacation requests for themselves; directors can submit for any fellow
- Denied requests shown in a separate section instead of being deleted
- Falls back to local-state behavior when Supabase is not configured

## 2026-02-09

- Landing page now shows first when visiting the site; "Enter Scheduler" navigates to login
- FellowShift logo on the login page is clickable and returns to the landing page
- Removed Vacation Mode button from Schedule view
- Removed rotation swapping (drag-and-drop and tap-to-swap)
- Added rotation highlight dropdown to filter and highlight all instances of a selected rotation across the year
- Non-matching cells fade to 30% opacity when a rotation is selected
- Retained click-to-highlight on fellow names, block headers, and individual cells
